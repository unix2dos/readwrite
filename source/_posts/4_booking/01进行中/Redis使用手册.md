---
doc_type: weread-highlights-reviews
bookId: "26562837"
author: 黄健宏
cover: https://cdn.weread.qq.com/weread/cover/59/YueWen_26562837/t7_YueWen_26562837.jpg
reviewCount: 1
noteCount: 16
title: 《Redis使用手册》
date: 2023-09-06
---


## 03第三部分 多机功能


- 📌 虽然一个主服务器可以拥有多个从服务器，但一个从服务器只能拥有一个主服务器。换句话说，Redis提供的是单主复制功能，而不是多主复制功能。 
    - ⏱ 2023-09-06 09:26:12 

- 📌 在默认情况下，处于复制模式的主服务器既可以执行写操作也可以执行读操作，而从服务器则只能执行读操作， 
    - ⏱ 2023-09-06 09:26:22 

- 📌 通过同时使用Redis的复制功能和Sentinel功能，用户可以为整个Redis系统提供高可用特性。具有这一特性的Redis系统在主服务器停机时，将会自动挑选一个从服务器作为新的主服务器，以此来继续为客户提供服务，避免造成整个系统停机。 
    - ⏱ 2023-09-06 09:27:06 
## 18.3 数据同步


- 📌 需要注意的是，因为在线更新是异步进行的，所以在主服务器执行完写命令之后，直到从服务器也执行完相同写命令的这段时间里，主从服务器的数据库将出现短暂的不一致，因此要求强一致性的程序可能需要直接读取主服务器而不是读取从服务器。 
    - ⏱ 2023-09-06 09:29:53 

- 📌 在Redis 2.8版本以前，重同步操作是通过直接进行完整同步来实现的，但是这种重同步方法在从服务器只是短暂下线的情况下是非常浪费资源的：主从服务器的数据库在连接断开之前一直都是相同的，造成数据不一致的原因可能仅仅是主服务器比从服务器多执行了几个写命令，而为了补上这部分写命令所产生的数据，却要大费周章地重新进行一次完整同步，这毫无疑问是非常低效的。 
    - ⏱ 2023-09-06 09:30:23 

- 📌 2.8版本开始使用新的重同步功能去代替原来的重同步功能：●当一个Redis服务器成为另一个服务器的主服务器时，它会把每个被执行的写命令都记录到一个特定长度的先进先出队列中。●当断线的从服务器尝试重新连接主服务器的时候，主服务器将检查从服务器断线期间，被执行的那些写命令是否仍然保存在队列里面。如果是，那么主服务器就会直接把从服务器缺失的那些写命令发送给从服务器执行，从服务器通过执行这些写命令就可以重新与主服务器保持一致，这样就避免了重新进行完整同步的麻烦。●如果从服务器缺失的那些写命令已经不存在于队列当中，那么主从服务器将进行一次完整同步。因为新的重同步功能需要使用先进先出队列来记录主服务器执行过的写命令，所以这个队列的体积越大，它能够记录的写命令就越多，从服务器断线之后能够快速地重新回到一致状态的机会也就越大。Redis为这个队列设置的默认大小为1MB，用户也可以根据自己的需要，通过配置选项repl-backlog-size来修改这个队列的大小。 
    - ⏱ 2023-09-06 09:31:16 
## 18.4 无须硬盘的复制


- 📌 Redis从2.8.18版本开始引入无须硬盘的复制特性（diskless replication）：启用了这个特性的主服务器在接收到REPLICAOF命令时将不会再在本地创建RDB文件，而是会派生出一个子进程，然后由子进程通过套接字直接将RDB文件写入从服务器。这样主服务器就可以在不创建RDB文件的情况下，完成与从服务器的数据同步。要使用无须硬盘的复制特性，我们只需要将repl-diskless-sync配置选项的值设置为yes即可： 
    - ⏱ 2023-09-06 09:32:02 

- 📌 最后要注意的是，无须硬盘的复制特性只是避免了在主服务器上创建RDB文件，但仍然需要在从服务器上创建RDB文件 
    - ⏱ 2023-09-06 09:33:08 
## 18.5 降低数据不一致情况出现的概率


- 📌 为了尽可能地降低数据不一致的出现概率，Redis从2.8版本开始引入了两个以min-replicas开头的配置选项：​​​​​​​​​ min-replicas-max-lag <seconds>￼ ￼ ​​​​​​​min-replicas-to-write <numbers>​​用户设置了这两个配置选项之后，主服务器只会在从服务器的数量大于等于min-replicas-to-write选项的值，并且这些从服务器与主服务器最后一次成功通信的间隔不超过min-replicas-max-lag选项的值时才会执行写命令。 
    - ⏱ 2023-09-06 09:36:07 
## 18.6 可写的从服务器


- 📌 使用可写从服务器的注意事项在使用可写的从服务器时，用户需要注意以下几个方面：●在主从服务器都可写的情况下，程序必须将写命令发送到正确的服务器上，不能把需要在主服务器执行的写命令发送给从服务器执行，也不能把需要在从服务器执行的写命令发送给主服务器执行，否则就会出现数据错误。●从服务器执行写命令得到的数据，可能会被主服务器发送的写命令覆盖。比如，如果从服务器在执行了客户端发送的SET msg "hello from client"命令之后，又接收到了主服务器发送的SET msg "hello from master"命令，那么客户端写入的msg键将被主服务器写入的msg键覆盖。基于这个原因，客户端在从服务器上面执行写命令时，应该尽量避免与主服务器发生键冲突，换句话说，用户应该让客户端和主服务器分别对从服务器数据库中不同的键进行写入，而不要让客户端和主服务器都去写相同的键。●当从服务器与主服务器进行完整同步时，从服务器数据库包含的所有数据都将被清空，其中包括客户端写入的数据。●为了减少内存占用，降低键冲突发生的可能性，并确保主从服务器的数据同步操作可以顺利进行，客户端写入从服务器的数据应该在使用完毕之后尽快删除。一个比较简单的方法是在客户端向从服务器写入数据的同时，为数据设置一个比较短的过期时间，使得这些数据可以在使用完毕之后自动被删除。 
    - ⏱ 2023-09-06 22:28:46 
## 20.1 基本特性


- 📌 在Redis集群中，各个Redis服务器被称为节点（node），其中主节点（master node）负责处理客户端发送的读写命令请求，而从节点（replica/slave node）则负责对主节点进行复制。除了复制功能之外，Redis集群还提供了类似于单机版Redis Sentinel的功能，以此来为集群提供高可用特性。简单来说，集群中的各个节点将互相监视各自的运行状况，并在某个主节点下线时，通过提升该节点的从节点为新主节点来继续提供服务。 
    - ⏱ 2023-09-06 23:05:06 

- 📌 与单机版Redis将整个数据库放在同一台服务器上的做法不同，Redis集群通过将数据库分散存储到多个节点上来平衡各个节点的负载压力。 
    - ⏱ 2023-09-06 23:05:36 

- 📌 除了节点之间互通信息带来的性能损耗之外，单个Redis集群节点处理命令请求的性能与单个Redis服务器处理命令请求的性能几乎别无二致。从理论上来讲，集群每增加一倍数量的主节点，集群对于命令请求的处理性能就会提高一倍。 
    - ⏱ 2023-09-06 23:06:36 
## 20.2 搭建集群


- 📌 在成功构建起集群之后，我们就可以使用客户端来连接并使用集群了，要做到这一点，最简单的就是使用Redis附带的redis-cli客户端。在连接集群节点而不是单机Redis服务器时，我们需要向redis-cli提供c（cluster，集群）参数以指示客户端进入集群模式，并通过h（host，主机地址）参数或p（port，端口号）参数指定集群中的某个节点作为入口： 
    - ⏱ 2023-09-06 23:08:53 

- 📌 如果接收到命令请求的节点并非负责处理命令所指键的节点，那么客户端将根据节点提示的转向信息再次向正确的节点发送命令请求，Redis集群把这个动作称为“转向”（redirect） 
    - ⏱ 2023-09-06 23:09:25 
## 示例：使用客户端连接集群


- 📌 为了连接集群，我们需要向客户端提供集群的节点地址。因为节点与节点之间一般都可以自动发现，所以我们通常只需要给定一个节点作为入口即可： 
    - ⏱ 2023-09-06 23:11:14 

# 读书笔记

## 18.3 数据同步

### 划线评论
- 📌 当一个Redis服务器成为另一个服务器的主服务器时，它会把每个被执行的写命令都记录到一个特定长度的先进先出队列中。  ^225207353-7L1bq8toO
    - 💭 一个环形队列
    - ⏱ 2023-09-06 09:31:29
   

# 本书评论
